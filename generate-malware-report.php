<?php

function getDirContents($dir, &$results = array()) {
   if (is_file($dir)) {
      $results[] = $dir;
      return $results;
   }

   $files = scandir($dir);

   foreach ($files as $key => $value) {
      $path = realpath($dir . DIRECTORY_SEPARATOR . $value);

      if (!is_dir($path)) {
         $results[] = $path;
      } else if ($value != '.' && $value != '..') {
         getDirContents($path, $results);
         $results[] = $path;
      }
   }

   return $results;
}

$infected_source = getDirContents('infected-source');
$infected_html = getDirContents('infected-html');
$results = array_merge($infected_html, $infected_source);

print_r($results);

for ($i = 0; $i < count($results); $i++) {
   $extension = pathinfo($results[$i], PATHINFO_EXTENSION);
   if ($extension == 'php' || $extension == 'js' || $extension == 'html' || $extension == 'txt') {
      
      // malware code sample
      $code = file($results[$i]);
      for ($j = 0; $j < count($code); $j++) {
         // todo: refactor re-use into function
         $code_sample = $code[$j];
         $code_sample = preg_replace('/\s{2,}/', ' ', $code_sample);
         $code_sample = substr($code_sample, 0, 100);

         if (strlen($code_sample) < 20 && !empty($code[$j + 1])) {
            $code_sample = $code[$j];
            $code_sample = preg_replace('/\s{2,}/', ' ', $code_sample);
            $code_sample = substr($code_sample, 0, 100);
         }
         else
            break;
      }

      for ($k = 0; $k < 100; $k++)
         printf("_");
      printf("\n\n\033[1mExample Malware:\033[0m\n");
      $code_sample = trim($code_sample);
      echo "$code_sample\n\n";

      // name and timestamp
      printf("\033[1mWas found in:\033[0m\n");
      $timestamp = @date("F d, Y H:i:s", filemtime($results[$i]));
      $strloc = strpos($results[$i], 'infected-source' ) + 16;
      if ($strloc === false)
         $strloc = strpos($results[$i], 'infected-html' ) + 14;
      $results[$i] = substr($results[$i], $strloc);
      printf($results[$i] . " [$timestamp]\n\n");

   } else {
      // skip
   }
}
 
